services:
  # Traefik - Reverse Proxy with automatic SSL
  traefik:
    image: traefik:v3.0
    container_name: traefik
    restart: unless-stopped
    ports:
      - "80:80"
      - "8080:8080"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./data/traefik:/data/traefik
    command:
      - --log.level=DEBUG
      - --accesslog=true
      - --accesslog.filepath=/var/log/traefik-access.log
      - --api.dashboard=true
      - --providers.docker=true
      - --providers.docker.exposedByDefault=false
      - --entryPoints.web.address=:80
      - --entrypoints.web.http.redirections.entryPoint.to=websecure
      - --entrypoints.web.http.redirections.entryPoint.scheme=https
      - --entryPoints.websecure.address=:443
      - --entryPoints.traefik.address=:8080
      - --certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL}
      - --certificatesresolvers.letsencrypt.acme.storage=/data/traefik/acme.json
      - --certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.entryPoints=traefik"
      - "traefik.http.routers.dashboard.rule=PathPrefix(`/api`) || PathPrefix(`/dashboard`) || PathPrefix(`/debug`)"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.middlewares=auth"
      - "traefik.http.middlewares.auth.basicauth.users=admin:${TRAEFIK_PW}"

  # PostgreSQL Database
  db:
    image: postgres:16-alpine
    container_name: nextcloud_db
    restart: unless-stopped
    volumes:
      - ./nextcloud_postgres:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: nextcloud_redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD}
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Nextcloud Application
  nextcloud:
    image: nextcloud:stable
    container_name: nextcloud_app
    restart: unless-stopped
    volumes:
      - nextcloud_data:/var/www/html
      - /mnt/raid_storage/nextcloud:/var/www/html/data
    environment:
      # Database
      - POSTGRES_HOST=db
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      # Redis
      - REDIS_HOST=redis
      - REDIS_HOST_PASSWORD=${REDIS_PASSWORD}
      # Nextcloud
      - NEXTCLOUD_TRUSTED_DOMAINS=${DOMAIN}
      - TRUSTED_PROXIES=traefik
      - OVERWRITEPROTOCOL=https
      # PHP Performance
      - PHP_MEMORY_LIMIT=2G
      - PHP_UPLOAD_LIMIT=10G
      - PHP_MAX_INPUT_TIME=3600
      - PHP_MAX_EXECUTION_TIME=3600
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      # Main Nextcloud router
      - "traefik.http.routers.nextcloud.tls=true"
      - "traefik.http.routers.nextcloud.tls.certresolver=letsencrypt"
      - "traefik.http.routers.nextcloud.entrypoints=websecure"
      - "traefik.http.routers.nextcloud.rule=Host(`${DOMAIN}`)"
      - "traefik.http.routers.nextcloud.middlewares=nextcloud-header,nextcloud-dav"
      # Middlewares
      - "traefik.http.middlewares.nextcloud-dav.redirectRegex.regex=https://(.*)/.well-known/(card|cal)dav"
      - "traefik.http.middlewares.nextcloud-dav.redirectRegex.replacement=https://$${1}/remote.php/dav/"
      - "traefik.http.middlewares.nextcloud-dav.redirectRegex.permanent=true"
      - "traefik.http.middlewares.nextcloud-header.headers.referrerPolicy=no-referrer"
      - "traefik.http.middlewares.nextcloud-header.headers.stsSeconds=15552000"
      - "traefik.http.middlewares.nextcloud-header.headers.forceSTSHeader=true"
      - "traefik.http.middlewares.nextcloud-header.headers.stsPreload=true"
      - "traefik.http.middlewares.nextcloud-header.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.nextcloud-header.headers.browserXssFilter=true"
      - "traefik.http.middlewares.nextcloud-header.headers.customRequestHeaders.X-Forwarded-Proto=https"
      # Service
      - "traefik.http.services.nextcloud.loadbalancer.server.port=80"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/status.php"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Collabora Online Office
  collabora:
    image: collabora/code:latest
    container_name: nextcloud_collabora
    restart: unless-stopped
    volumes:
      - collabora_systemplate:/opt/cool/systemplate
    environment:
      - aliasgroup1=https://${DOMAIN}
      - username=${COLLABORA_USERNAME}
      - password=${COLLABORA_PASSWORD}
      - extra_params=--o:ssl.enable=false --o:ssl.termination=true
    tty: true
    cap_add:
      - MKNOD
      - SYS_CHROOT
    labels:
      - "traefik.enable=true"
      # Main router for Collabora
      - "traefik.http.routers.collabora.tls=true"
      - "traefik.http.routers.collabora.tls.certresolver=letsencrypt"
      - "traefik.http.routers.collabora.entrypoints=websecure"
      - "traefik.http.routers.collabora.rule=Host(`office.${DOMAIN}`)"
      - "traefik.http.routers.collabora.middlewares=collabora-header"
      # Headers middleware
      - "traefik.http.middlewares.collabora-header.headers.referrerPolicy=no-referrer"
      - "traefik.http.middlewares.collabora-header.headers.stsSeconds=15552000"
      - "traefik.http.middlewares.collabora-header.headers.forceSTSHeader=true"
      - "traefik.http.middlewares.collabora-header.headers.stsPreload=true"
      - "traefik.http.middlewares.collabora-header.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.collabora-header.headers.browserXssFilter=true"
      - "traefik.http.middlewares.collabora-header.headers.customRequestHeaders.X-Forwarded-Proto=https"
      # Service
      - "traefik.http.services.collabora.loadbalancer.server.port=9980"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9980/hosting/discovery"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Nextcloud Cron Job
  nextcloud-cron:
    image: nextcloud:stable
    container_name: nextcloud_cron
    restart: unless-stopped
    volumes:
      - nextcloud_data:/var/www/html
      - /mnt/raid_storage/nextcloud:/var/www/html/data
    entrypoint: /cron.sh
    environment:
      - POSTGRES_HOST=db
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - REDIS_HOST=redis
      - REDIS_HOST_PASSWORD=${REDIS_PASSWORD}
    depends_on:
      - db
      - redis

  # Database Backup Service (Optional but recommended)
  db-backup:
    image: postgres:16-alpine
    container_name: nextcloud_db_backup
    restart: unless-stopped
    volumes:
      - /mnt/raid_storage/postgres-nc-backup:/backup
    environment:
      - PGPASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_DB=${POSTGRES_DB}
    entrypoint: |
      sh -c 'while true; do
        pg_dump -h db -U $$POSTGRES_USER $$POSTGRES_DB > /backup/nextcloud_$$(date +%Y%m%d_%H%M%S).sql
        find /backup -name "*.sql" -mtime +7 -delete
        echo "Backup completed at $$(date)"
        sleep 86400
      done'
    depends_on:
      - db

  immich-server:
    container_name: immich_server
    image: ghcr.io/immich-app/immich-server:${IMMICH_VERSION:-release}
    volumes:
      - ${UPLOAD_LOCATION}:/data
      - /etc/localtime:/etc/localtime:ro
    environment:
      - DB_HOSTNAME=immich-db
      - DB_USERNAME=${IMMICH_DB_USERNAME}
      - DB_PASSWORD=${IMMICH_DB_PASSWORD}
      - DB_DATABASE_NAME=${IMMICH_DB_NAME}
      - REDIS_HOSTNAME=immich-redis
    ports:
      - "2283:2283"
    depends_on:
      - immich-redis
      - immich-db
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.immich.tls=true"
      - "traefik.http.routers.immich.tls.certresolver=letsencrypt"
      - "traefik.http.routers.immich.entrypoints=websecure"
      - "traefik.http.routers.immich.rule=Host(`${IMMICH_DOMAIN}`)"
      - "traefik.http.routers.immich.middlewares=immich-header"
      # Headers middleware
      - "traefik.http.middlewares.immich-header.headers.referrerPolicy=no-referrer"
      - "traefik.http.middlewares.immich-header.headers.stsSeconds=15552000"
      - "traefik.http.middlewares.immich-header.headers.forceSTSHeader=true"
      - "traefik.http.middlewares.immich-header.headers.stsPreload=true"
      - "traefik.http.middlewares.immich-header.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.immich-header.headers.browserXssFilter=true"
      - "traefik.http.middlewares.immich-header.headers.customRequestHeaders.X-Forwarded-Proto=https"
      # Service
      - "traefik.http.services.immich.loadbalancer.server.port=2283"

    healthcheck:
      disable: false

  immich-machine-learning:
    container_name: immich_machine_learning
    image: ghcr.io/immich-app/immich-machine-learning:${IMMICH_VERSION:-release}
    volumes:
      - model-cache:/cache
    restart: unless-stopped
    healthcheck:
      disable: false

  immich-redis:
    container_name: immich_redis
    image: docker.io/valkey/valkey:8@sha256:81db6d39e1bba3b3ff32bd3a1b19a6d69690f94a3954ec131277b9a26b95b3aa
    healthcheck:
      test: redis-cli pint || exit 1
    restart: unless-stopped

  immich-db:
    container_name: immich_postgres
    image: ghcr.io/immich-app/postgres:14-vectorchord0.4.3-pgvectors0.2.0@sha256:bcf63357191b76a916ae5eb93464d65c07511da41e3bf7a8416db519b40b1c23
    environment:
      POSTGRES_PASSWORD: ${IMMICH_DB_PASSWORD}
      POSTGRES_USER: ${IMMICH_DB_USERNAME}
      POSTGRES_DB: ${IMMICH_DB_NAME}
      POSTGRES_INITDB_ARGS: '--data-checksums'
    volumes:
      - ${DB_DATA_LOCATION}:/var/lib/postgresql/data
    shm_size: 128mb
    restart: unless-stopped


volumes:
  collabora_systemplate:
    name: collabora_systemplate
  nextcloud_data:
    name: nextcloud_data
  model-cache:
    name: model-cache


